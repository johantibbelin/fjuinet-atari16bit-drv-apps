'
' Disk code written for Fujinet Atari 16bit
'
' Disk image explorer, drivers and more
'
' ------------------------------------
' Inline data
' ------------------------------------
' ASM routines
INLINE asm%,2048
' ------------------------------------
RESERVE 100000
CLS
diskimg_load
diskimg_examine
diskimg_unload
RESERVE
END
> PROCEDURE low
  LOCAL scr%
  scr%=XBIOS(2)
  ~XBIOS(5,L:scr%,L:scr%,0)
  SETCOLOR 3,&H520
  SETCOLOR 15,&H0
  CLS
RETURN
> PROCEDURE medium
  LOCAL scr%
  scr%=XBIOS(2)
  ~XBIOS(5,L:scr%,L:scr%,1)
  SETCOLOR 3,&H0
  CLS
RETURN
PROCEDURE diskimg_load
  FILESELECT "I:\*.st","",file$
  PRINT file$
  dimg%=MALLOC(82*10*512*2)
  IF dimg%<0
    PRINT "not enough ram!"
    GOTO ret
  ENDIF
  PRINT "$";HEX$(dimg%)
  BLOAD file$,dimg%
  '  ~MFREE(dimg%)
ret:
RETURN
PROCEDURE diskimg_unload
  ~MFREE(dimg%)
RETURN
PROCEDURE diskimg_examine
  FOR i%=0 TO 20 STEP 2
    PRINT "$"+HEX$(DPEEK(dimg%+i%))
  NEXT i%
  ' Print directory
  CLS
  skip!=FALSE
  ddir%=dimg%+&H1600
  FOR d%=ddir% TO ddir%+(&H20*20) STEP &H20
    FOR i%=0 TO 10
      IF i%=0 AND PEEK(d%)=&HE5
        PRINT "?";
      ELSE IF i%=0 AND PEEK(d%)=0
        i%=10
        skip!=TRUE
      ELSE
        PRINT CHR$(PEEK(d%+i%));
      ENDIF
      IF i%=7
        PRINT ".";
      ENDIF
    NEXT i%
    IF skip!=TRUE
      skip!=FALSE
    ELSE
      PRINT
    ENDIF
  NEXT d%
  ~INP(2)
RETURN
